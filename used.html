<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>‡πÇ‡∏≠‡πÄ‡∏Ñ ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢ | ‡∏£‡πâ‡∏≤‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</title>
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Papa Parse -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;700&display=swap');
        .font-prompt {
            font-family: 'Prompt', sans-serif;
        }
        @layer utilities {
            .text-primary { color: #4f46e5; }
            .text-secondary { color: #ec4899; }
            .bg-primary { background-color: #4f46e5; }
            .bg-secondary { background-color: #ec4899; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100 text-gray-800 font-prompt min-h-screen">

    <!-- Header -->
    <header class="bg-gradient-to-r from-pink-500 via-red-500 to-yellow-500 shadow-xl p-8 text-center rounded-b-3xl sticky top-0 z-10 relative">
        <h1 class="text-6xl font-extrabold text-white drop-shadow-2xl tracking-wide">
            ‡πÇ‡∏≠‡πÄ‡∏Ñ ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢
        </h1>
        <p class="text-gray-100 mt-2 text-xl font-medium drop-shadow-lg">
            üì± OK-MOBILE SHOP ONLINE | ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á
        </p>

        <!-- View Counter -->
        <div class="absolute top-4 right-4 bg-white/30 backdrop-blur-sm p-2 px-4 rounded-full shadow-lg border border-white/50">
            <span class="text-sm font-semibold text-white">‡∏¢‡∏≠‡∏î‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°:</span>
            <span id="view-count" class="text-lg font-extrabold text-yellow-100 ml-1">...</span>
        </div>
    </header>

    <!-- Navigation & Search/Sort Section -->
    <div class="p-6 max-w-6xl mx-auto">
        
        <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô & ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å -->
        <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 my-6">
            <a href="warranty.html" class="inline-flex items-center justify-center bg-blue-600 text-white px-8 py-3 rounded-full shadow-lg hover:bg-blue-700 transition-transform transform hover:scale-105 font-semibold text-lg">
                üîç ‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            </a>
            <a href="index.html" class="inline-flex items-center justify-center bg-gray-600 text-white px-8 py-3 rounded-full shadow-lg hover:bg-gray-700 transition-transform transform hover:scale-105 font-semibold text-lg">
                üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </a>
        </div>

        <!-- Search Input & Sort Dropdown -->
        <div class="flex flex-col md:flex-row gap-4 mb-8 mt-6 items-center">
            <!-- Search Input -->
            <input type="text" id="product-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô iPhone, Samsung, Xiaomi)"
                   class="w-full md:w-2/3 p-4 border-2 border-pink-400 rounded-xl shadow-inner text-lg focus:ring-4 focus:ring-pink-300 transition duration-300">
            
            <!-- Sort Dropdown -->
            <select id="product-sort" class="w-full md:w-1/3 p-4 border-2 border-pink-400 rounded-xl shadow-inner text-lg bg-white appearance-none cursor-pointer focus:ring-4 focus:ring-pink-300 transition duration-300">
                <option value="default">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)</option>
                <option value="price-asc">‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å (‚Üë)</option>
                <option value="price-desc">‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢ (‚Üì)</option>
            </select>
        </div>

        <!-- Product Grid Title -->
        <h2 class="text-4xl font-bold text-gray-800 mb-6 border-b-4 border-pink-500 pb-2">
            ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô
        </h2>
        
        <!-- Product Grid -->
        <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
            <p id="loading" class="text-gray-500 text-center col-span-full py-10 text-xl animate-pulse">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà
            </p>
        </div>
    </div>

    <!-- Footer for design completeness -->
    <footer class="mt-12 p-6 bg-pink-500 text-white text-center rounded-t-3xl shadow-inner">
        <p>¬© 2025 OK-MOBILE Shop Online. ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏à ‡πÉ‡∏™‡πà‡πÉ‡∏à‡∏ó‡∏∏‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</p>
    </footer>

    <script type="module">
        // --- Firebase/Firestore Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables and Constants ---
        let allProducts = [];
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3Ks0x16haRC2E60V7UzcEYGul-goV234Uenpln-wtFCtFgkoxUfTeGlBnSEZr65MisugNJtR1AvQF/pub?gid=715824064&output=csv';
        const grid = document.getElementById('product-grid');
        const loading = document.getElementById('loading');
        const searchInput = document.getElementById('product-search');
        const sortInput = document.getElementById('product-sort');
        const viewCountElement = document.getElementById('view-count');

        // Firestore setup variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        let db;
        let auth;
        let isAuthReady = false;

        // Function to format price with Thai locale
        const formatPrice = (price) => Number(price).toLocaleString('th-TH');

        // Function to render products onto the grid
        const renderProducts = (products) => {
            grid.innerHTML = ''; // Clear existing products

            if (products.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-10">' +
                                 '<p class="text-2xl text-red-500 font-semibold">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>' +
                                 '<p class="text-gray-500 mt-2">‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô</p>' +
                                 '</div>';
                return;
            }

            products.forEach(item => {
                const name = item.name?.trim() || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
                const price = item.price?.trim() || '0';
                const image = item.image?.trim() || 'https://placehold.co/400x300/fecaca/9f1239?text=NO+IMAGE'; 
                const facebook = item.facebook?.trim() || 'https://www.facebook.com/profile.php?id=61566120762780'; 
                
                // All items are assumed to be in stock
                const buyButtonClass = 'w-full text-center bg-green-500 text-white px-4 py-3 rounded-full text-lg font-semibold hover:bg-green-600 transition shadow-md hover:shadow-lg';
                const buyButtonText = 'üõí ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
                const buyButtonHref = 'https://www.facebook.com/profile.php?id=61566120762780'; 
                const buyButtonTarget = '_blank';


                const card = document.createElement('div');
                // Standard card styling
                card.className = `bg-white p-6 rounded-3xl shadow-xl hover:shadow-2xl transition duration-300 transform hover:-translate-y-1 border border-gray-100 relative`;
                
                card.innerHTML = `
                    <div class="h-64 mb-4 overflow-hidden rounded-xl relative">
                        <img src="${image}" alt="‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á ${name}"
                            class="w-full h-full object-cover transition-transform duration-500 hover:scale-105"
                            onerror="this.src='https://placehold.co/400x300/fecaca/9f1239?text=NO+IMAGE'">
                    </div>
                    <h3 class="text-2xl font-bold mb-1 text-gray-900 truncate">${name}</h3>
                    <p class="text-3xl font-extrabold mb-4 text-pink-600">
                        <span class="text-2xl font-normal">‡∏ø</span>${formatPrice(price)}
                    </p>
                    <div class="flex flex-col space-y-3">
                        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î -->
                        <a href="${facebook}" target="_blank" rel="noopener noreferrer"
                            class="w-full text-center bg-secondary text-white px-4 py-3 rounded-full text-lg font-semibold hover:bg-pink-600 transition shadow-md hover:shadow-lg">
                            üîó ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                        </a>
                        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Always active) -->
                        <a href="${buyButtonHref}" target="${buyButtonTarget}" rel="noopener noreferrer"
                            class="${buyButtonClass}">
                            ${buyButtonText}
                        </a>
                    </div>
                `;
                grid.appendChild(card);
            });
        };

        // Function to filter and sort products based on user inputs 
        const filterAndSortProducts = () => {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const sortMethod = sortInput.value;
            
            // 1. Filter based on search term
            const filtered = allProducts.filter(product => {
                const name = product.name?.trim()?.toLowerCase() || '';
                return name.includes(searchTerm);
            });

            // 2. Sort based on selection
            let sorted = [...filtered]; 

            if (sortMethod === 'price-asc') {
                sorted.sort((a, b) => {
                    return (parseFloat(a.price) || 0) - (parseFloat(b.price) || 0);
                });
            } else if (sortMethod === 'price-desc') {
                sorted.sort((a, b) => {
                    return (parseFloat(b.price) || 0) - (parseFloat(a.price) || 0);
                });
            }
            
            // 3. Render the final list
            renderProducts(sorted);
        };
        
        // --- View Counter Logic ---
        const VIEWS_DOC_ID = 'product_page_views';

        /**
         * Increments the view counter in Firestore.
         */
        const updateViewCount = async () => {
            if (!isAuthReady || !db) return;

            const viewsRef = doc(db, 'artifacts', appId, 'public', 'data', 'site_stats', VIEWS_DOC_ID);
            
            try {
                // Attempt to increment the counter
                await updateDoc(viewsRef, {
                    count: increment(1)
                });
            } catch (error) {
                // If the document doesn't exist, create it with count = 1
                if (error.code === 'not-found' || error.message.includes('No document to update')) {
                     await setDoc(viewsRef, { count: 1 }, { merge: true });
                } else {
                    console.error("Error updating view count:", error);
                }
            }
        };

        /**
         * Sets up a real-time listener for the view count and updates the UI.
         */
        const setupViewCountListener = () => {
             if (!isAuthReady || !db) return;

            const viewsRef = doc(db, 'artifacts', appId, 'public', 'data', 'site_stats', VIEWS_DOC_ID);
            
            onSnapshot(viewsRef, (docSnap) => {
                if (docSnap.exists()) {
                    const count = docSnap.data().count || 0;
                    viewCountElement.textContent = count.toLocaleString();
                } else {
                    viewCountElement.textContent = '0';
                }
            }, (error) => {
                console.error("Error listening to view count:", error);
            });
        };
        
        /**
         * Initializes Firebase and authenticates.
         */
        const initializeFirebase = async () => {
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                 console.error("Firebase config is missing.");
                 viewCountElement.textContent = 'N/A';
                 return;
            }
            
            try {
                // setLogLevel('debug'); // Uncomment for debugging
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                isAuthReady = true;
                
                // Once authenticated, update and listen to the view counter
                await updateViewCount();
                setupViewCountListener();

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                viewCountElement.textContent = 'Error';
            }
        };


        // --- Main Initialization ---
        
        // 1. Initialize data loading (products)
        Papa.parse(csvUrl, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                // Remove loading indicator
                loading?.remove(); 
                
                // Store all data and clean price string (remove commas) for reliable numerical sorting
                allProducts = results.data
                    .filter(item => item.name && item.price) 
                    .map(item => ({
                        ...item,
                        // Clean up the price string before use
                        price: item.price ? String(item.price).replace(/,/g, '') : '0' 
                    })); 

                filterAndSortProducts(); // Call the combined function to render initial state

                // Attach listeners to trigger filtering and sorting
                searchInput.addEventListener('keyup', filterAndSortProducts);
                searchInput.addEventListener('change', filterAndSortProducts);
                sortInput.addEventListener('change', filterAndSortProducts); 
            },
            error: function(err) {
                console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:', err);
                grid.innerHTML = '<p class="text-3xl text-red-600 font-bold col-span-full text-center py-10">' + 
                                 '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å Google Sheet' + 
                                 '</p>';
            }
        });

        // 2. Initialize Firebase for view counter
        initializeFirebase();
    </script>

</body>
</html>