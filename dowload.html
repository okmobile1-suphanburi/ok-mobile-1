<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏±‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á OK Mobile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gradient-to-br from-purple-200 via-pink-200 to-yellow-200 min-h-screen flex flex-col items-center p-4">

  <h1 class="text-4xl font-extrabold text-purple-700 my-6 text-center">üéÅ ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô OK Mobile</h1>

  <div id="coupon-container" class="grid grid-cols-1 sm:grid-cols-2 gap-6 max-w-6xl w-full"></div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzqMwRg9UE6Ha51MIikUI5cXAfhfufKbkun_eOdjKjT9E0QGOLWvFUHoUKaTPFnvtsI/exec";
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSbQLWeunt6AJ2Fx4rOxDL6-pLIQVaLjodFOCFY-6ZdqbUW7pDpsom6AEWnLBPRbADfR0LHPTH7-M9u/pub?gid=0&single=true&output=csv";

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á device_id ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
    function getDeviceId() {
      let id = localStorage.getItem("device_id");
      if (!id) {
        id = "dev-" + Math.random().toString(36).substr(2, 9);
        localStorage.setItem("device_id", id);
      }
      return id;
    }

    async function loadCoupons() {
      const res = await fetch(SHEET_CSV_URL);
      const text = await res.text();
      const parsed = Papa.parse(text, { header: true });
      const rows = parsed.data;
      const container = document.getElementById("coupon-container");

      rows.forEach((row, index) => {
        const { title, description, color, line_url } = row;

        const div = document.createElement("div");
        div.className = "bg-white shadow-2xl rounded-3xl p-6 text-center relative overflow-hidden";

        div.innerHTML = `
          <h2 class="text-2xl font-bold mb-4" style="color:${color}">${title}</h2>
          <p class="mb-6 text-gray-700">${description}</p>
          <a href="${line_url}" target="_blank" class="block bg-green-500 text-white px-5 py-3 rounded-xl font-bold text-lg hover:bg-green-600 transition mb-3 add-line-btn">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô LINE</a>
          <button style="background-color:${color};"
                  class="text-white px-5 py-3 rounded-xl font-bold text-lg hover:opacity-90 transition get-code-btn disabled:opacity-50 w-full"
                  disabled>üéüÔ∏è ‡∏£‡∏±‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</button>
          <p class="mt-4 font-bold result" style="color:${color}"></p>
        `;
        container.appendChild(div);
      });

      setupButtons();
    }

    function setupButtons() {
      document.querySelectorAll(".add-line-btn").forEach((btn) => {
        const getCodeBtn = btn.nextElementSibling;
        btn.addEventListener("click", () => {
          // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
          setTimeout(() => {
            getCodeBtn.disabled = false;
            alert("‚úÖ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô LINE ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!");
          }, 500);
        });
      });

      document.querySelectorAll(".get-code-btn").forEach((btn, index) => {
        btn.addEventListener("click", async () => {
          const resultElem = btn.parentElement.querySelector(".result");
          const deviceId = getDeviceId();

          try {
            const res = await fetch(`${SCRIPT_URL}?device_id=${deviceId}&coupon_id=${index}`);
            const data = await res.json();

            if (data.status === "ok") {
              resultElem.textContent = "üéâ ‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: " + data.code;
              const color = btn.parentElement.querySelector("h2").style.color;
              confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 },
                colors: [color, "#fff", "#ffd700"]
              });
            } else {
              resultElem.textContent = "‚ö†Ô∏è " + data.message;
            }
          } catch (err) {
            console.error(err);
            resultElem.textContent = "‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà";
          }
        });
      });
    }

    loadCoupons();
  </script>

</body>
</html>
