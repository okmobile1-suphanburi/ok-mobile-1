<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏±‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á OK Mobile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gradient-to-br from-purple-200 via-pink-200 to-yellow-200 min-h-screen flex flex-col items-center p-4">

  <h1 class="text-4xl font-extrabold text-purple-700 my-6 text-center">üéÅ ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô OK Mobile</h1>

  <div id="coupon-container" class="grid grid-cols-1 sm:grid-cols-2 gap-6 max-w-6xl w-full"></div>

  <!-- Toast ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
  <div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-xl hidden z-50"></div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzYOVdTqqeQlVsNQlCpff5IyQjYCH8y5K9wR2JMNGyWj1YpOOlJn9uO5xbnSVa50Uny/exechttps://script.google.com/macros/s/AKfycbzYOVdTqqeQlVsNQlCpff5IyQjYCH8y5K9wR2JMNGyWj1YpOOlJn9uO5xbnSVa50Uny/exec?device_id=dev-123&coupon_id=0
";
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSbQLWeunt6AJ2Fx4rOxDL6-pLIQVaLjodFOCFY-6ZdqbUW7pDpsom6AEWnLBPRbADfR0LHPTH7-M9u/pub?gid=0&single=true&output=csv";

    function showToast(msg, color="bg-green-600") {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.className = `fixed bottom-4 right-4 text-white px-4 py-2 rounded-lg shadow-xl z-50 ${color}`;
      toast.classList.remove("hidden");
      setTimeout(() => toast.classList.add("hidden"), 3000);
    }

    function getDeviceId() {
      let id = localStorage.getItem("device_id");
      if (!id) {
        id = "dev-" + Math.random().toString(36).substr(2, 9);
        localStorage.setItem("device_id", id);
      }
      return id;
    }

    async function loadCoupons() {
      const res = await fetch(SHEET_CSV_URL);
      const text = await res.text();
      const parsed = Papa.parse(text, { header: true });
      const rows = parsed.data;
      const container = document.getElementById("coupon-container");

      const today = new Date();

      rows.forEach((row, index) => {
        if (!row.title || !row.line_url) return; // ‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á

        const expiryDate = row.expiry_date ? new Date(row.expiry_date) : null;
        const isExpired = expiryDate && expiryDate < today;

        const div = document.createElement("div");
        div.className = "bg-white shadow-2xl rounded-3xl p-6 text-center relative overflow-hidden";

        div.innerHTML = `
          <h2 class="text-2xl font-bold mb-4" style="color:${row.color}">${row.title}</h2>
          <p class="mb-3 text-gray-700">${row.description}</p>
          ${expiryDate ? `<p class="mb-3 text-sm text-gray-500">‚è≥ ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ñ‡∏∂‡∏á: ${expiryDate.toLocaleDateString("th-TH")}</p>` : ""}
          <a href="${row.line_url}" target="_blank" class="block bg-green-500 text-white px-5 py-3 rounded-xl font-bold text-lg hover:bg-green-600 transition mb-3 add-line-btn">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô LINE</a>
          <button style="background-color:${row.color};"
                  class="text-white px-5 py-3 rounded-xl font-bold text-lg hover:opacity-90 transition get-code-btn disabled:opacity-50 w-full"
                  ${isExpired ? "disabled" : "disabled"}>üéüÔ∏è ‡∏£‡∏±‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</button>
          <p class="mt-4 font-bold result" style="color:${row.color}">${isExpired ? "‚è∞ ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß" : ""}</p>
        `;
        container.appendChild(div);
      });

      setupButtons();
    }

    function setupButtons() {
      const usedCoupons = JSON.parse(localStorage.getItem("used_coupons") || "[]");

      document.querySelectorAll(".add-line-btn").forEach((btn, index) => {
        const getCodeBtn = btn.nextElementSibling;
        const resultElem = btn.parentElement.querySelector(".result");

        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏£‡∏±‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß
        if (usedCoupons.includes(index)) {
          getCodeBtn.disabled = true;
          resultElem.textContent = "üéüÔ∏è ‡∏Ñ‡∏∏‡∏ì‡∏£‡∏±‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß";
          return;
        }

        // ‡∏ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡πâ‡∏≤‡∏°
        if (resultElem.textContent.includes("‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏")) return;

        btn.addEventListener("click", () => {
          setTimeout(() => {
            getCodeBtn.disabled = false;
            showToast("‚úÖ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô LINE ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!");
          }, 500);
        });
      });

      document.querySelectorAll(".get-code-btn").forEach((btn, index) => {
        btn.addEventListener("click", async () => {
          const resultElem = btn.parentElement.querySelector(".result");
          if (resultElem.textContent.includes("‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏")) return;

          const deviceId = getDeviceId();

          try {
            const res = await fetch(`${SCRIPT_URL}?device_id=${deviceId}&coupon_id=${index}`);
            const data = await res.json();

            if (data.status === "ok") {
              resultElem.textContent = "üéâ ‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: " + data.code;
              const color = btn.parentElement.querySelector("h2").style.color;
              confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 },
                colors: [color, "#fff", "#ffd700"]
              });

              // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß
              const usedCoupons = JSON.parse(localStorage.getItem("used_coupons") || "[]");
              usedCoupons.push(index);
              localStorage.setItem("used_coupons", JSON.stringify(usedCoupons));
              btn.disabled = true;

            } else {
              resultElem.textContent = "‚ö†Ô∏è " + data.message;
              showToast("‚ö†Ô∏è " + data.message, "bg-red-600");
            }
          } catch (err) {
            console.error(err);
            resultElem.textContent = "‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà";
            showToast("‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", "bg-red-600");
          }
        });
      });
    }

    loadCoupons();
  </script>

</body>
</html>
